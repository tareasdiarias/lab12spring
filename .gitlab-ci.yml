stages:
  - test
  - build-backend
  - build-frontend

# Variables para la base de datos del servicio PostgreSQL
variables:
  POSTGRES_DB: lab012
  POSTGRES_USER: usuario
  POSTGRES_PASSWORD: password
  POSTGRES_HOST_AUTH_METHOD: trust

# Levanta el servicio de PostgreSQL para todos los jobs
services:
  - name: postgres:15
    alias: postgres

# TEST: Pruebas del backend con conexiÃ³n a PostgreSQL
backend-test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - echo "db.host=postgres" > src/test/resources/application-test.properties
    - echo "db.port=5432" >> src/test/resources/application-test.properties
    - echo "db.username=usuario" >> src/test/resources/application-test.properties
    - echo "db.password=password" >> src/test/resources/application-test.properties
    - mvn clean test -B
  allow_failure: false

# BUILD: Compila y empaqueta el backend
backend-build:
  stage: build-backend
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - mvn clean package -B -DskipTests
  artifacts:
    paths:
      - target/*.jar

# BUILD FRONTEND: Instala dependencias, corre pruebas y compila React
frontend-build:
  stage: build-frontend
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run test -- --watchAll=false
    - npm run build
  artifacts:
    paths:
      - frontend/build
  allow_failure: false
